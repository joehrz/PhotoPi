# PhotoPi: Point Cloud Analysis Toolkit

This directory contains the tools and Python modules for analyzing 3D point clouds of plants generated by the PhotoPi system (typically from the COLMAP reconstruction pipeline on the remote server). It provides scripts to load point clouds, process them, and extract various quantitative phenotypic traits.

For a general overview of the entire PhotoPi project, please see the [main README.md](../../../README.md).

## Table of Contents

* [Overview](#overview)
* [Core Modules and Functionality](#core-modules-and-functionality)
* [Prerequisites](#prerequisites)
* [Installation](#installation)
* [Configuration Files](#configuration-files)
    * [`metrics_config.json`](#metrics_configjson)
    * [`scale_values.json`](#scale_valuesjson)
* [Usage (`main.py`)](#usage-mainpy)
    * [Command-Line Arguments](#command-line-arguments)
    * [Example Invocation](#example-invocation)
* [Detailed Analysis Modules](#detailed-analysis-modules)
* [Output](#output)
* [Extending with New Analyses](#extending-with-new-analyses)
* [Troubleshooting](#troubleshooting)

## Overview

After a 3D point cloud of a plant is successfully reconstructed, this toolkit enables the extraction of meaningful biological measurements. These metrics can be used to assess plant growth, morphology, and response to various treatments, contributing to research in plant science, agriculture, and breeding. The system is designed to be modular, allowing users to run specific analyses as needed.


## Visual Overview

<p align="center">
<img src="../../docs/images/Wheat_Gladius_B6_2023-06-27-2029_labeled_pcd_with_leaf_angles.svg" alt="Example wheat plant analysis showing segmented stem (red), leaves (green), and measured leaf angles" width="1400"/>
</p>

*Automated wheat analysis: stem segmentation (red), leaves (green), and leaf angle measurements*

## Core Modules and Functionality

The analysis toolkit is primarily driven by `main.py` which orchestrates various specialized modules located in the `point_cloud/` and `utils/` subdirectories:

* **`main.py`**: Command-line script to load a `.ply` point cloud, select and run analysis modules, and save results to a CSV file.
* **`point_cloud/processing.py` (`PointCloudProcessor`)**: Handles initial point cloud preparation: centering, color-based filtering (e.g., for turntable points using fixed HSV-like thresholds), plane segmentation (RANSAC), Z-axis alignment, and turntable ring parameter estimation for potential scaling or registration.
* **`point_cloud/convex_hull.py` (`ConvexHullAnalyzer`)**: Computes the 3D convex hull of the plant and its volume using `scipy.spatial.ConvexHull`. Also supports calculating volume for a top percentile of points based on Z-values (e.g., volume of top 60% or 40%).
* **`point_cloud/hr_analysis.py` (`HRAnalyzer`)**: Implements `HRAnalyzer` to determine plant height (H_Max), maximum radius (R_Max), and the H/R ratio. This module often leverages main stem segmentation to define a proper base for height measurements.
* **`point_cloud/projection.py` (`ProjectionAnalyzer`)**: Features `ProjectionAnalyzer` which calculates the 2D ground-plane projected area of the plant, typically using an alpha shape algorithm (`alphashape` library).
* **`point_cloud/segmentation_extractor.py` (`Segmentation`)**: A general-purpose class for segmenting point clouds into distinct clusters. It employs a workflow including voxel downsampling, k-NN graph construction, edge pruning based on distance, connected components analysis for initial labeling, MST-based refinement of clusters, and filtering of small clusters. It can also map labels back to the original high-resolution cloud.
* **`point_cloud/main_stem_segmentation.py` (`MainStemSegmentation`)**: An advanced module designed to identify and segment the main stem of a plant from leaves and branches. It uses a multi-step process involving Z-slicing, DBSCAN clustering within slices, merging/unifying clusters, building adjacency graphs between slice clusters (with different cost functions, e.g., simple bipartite or vertical-based), bridging disconnected subgraphs, and applying a "raindrop model" (negative cost path finding on a DAG) to trace the stem. It labels points as 'stem', 'leaf', or 'branch_off' and saves labeled data.
* **`point_cloud/leaf_angles.py` (`LeafAngleAnalyzer`)**: Measures leaf attachment angles relative to the main stem, requiring output from `MainStemSegmentation` (graph, centroids, trunk path, branch-off nodes). It samples points, fits lines using SVD, and calculates angles.
* **`utils/helpers.py`**: Contains utility functions for tasks like color-based point filtering, vector normalization, normal vector extraction from plane models, and Cartesian to cylindrical coordinate conversion.
* **`utils/mysql_database.py`**: Provides a function (`insert_metrics_to_mysql`) to insert or update metrics rows in a MySQL database, suggesting an optional integration for persistent metric storage.

## Prerequisites

* Python 3.x
* Python Packages (install via `pip install -e .[point_cloud_analysis]` or `.[all]` from the project root, as defined in `setup.py`):
    * `numpy`
    * `open3d`
    * `matplotlib`
    * `scipy`
    * `scikit-learn`
    * `networkx`
    * `alphashape`
    * `shapely`
    * `mysql-connector-python` (If using MySQL database logging. Ensure this is added to `setup.py`'s `point_cloud_analysis_deps` or install separately).

## Installation

If the main PhotoPi package was installed from the project root with the `[point_cloud_analysis]` or `[all]` extras, the dependencies for this toolkit should already be satisfied.
```bash
# From the root of the PhotoPi project:
pip install -e .[point_cloud_analysis]